import React, { useEffect } from 'react'
import { useDispatch, useSelector } from 'react-redux'

import { AppLayout } from 'containers/AppLayout'
import { WishCard } from 'components/WishCard'
import { fetchWishes } from 'store/wishesSlice'
import { addColumn,
         setWorkSpaceWidth,
         resetColumns,
         fillWaitList,
         takeWishToRender} from 'store/wishColumnSlice'



export const WishCardsLayout = () => {
    const dispatch = useDispatch();
    const loadWishes = () => dispatch(fetchWishes());
    const oneMoreColumnPlease = () => dispatch(addColumn());
    const clearColumns = () => dispatch(resetColumns());
    const updateWidth = () => dispatch(setWorkSpaceWidth(document.querySelector('.work-space').clientWidth));
    const updateRenderWaitList = () => dispatch(fillWaitList( wishes ));

    const columnObjects = useSelector(state => state.wishColumns.wishColumns);
    const wishes = useSelector(state => state.wishes.wishes);
    const workSpaceWidth = useSelector(state => state.wishColumns.workSpaceWidth);
    const wishesToRender = useSelector(state => state.wishColumns.wishesToRender);

    
    
    const [outerSpacing, innerSpacing, columnMinimalWidth] = [55, 22, 220];
    const columnsQty = Math.floor((workSpaceWidth - 2 * outerSpacing + innerSpacing) / (columnMinimalWidth + innerSpacing))

    useEffect(() => {
        loadWishes();
        updateRenderWaitList();
    },[])

    useEffect(() => {
        updateWidth();
        updateRenderWaitList();
        window.addEventListener('resize', updateWidth);
        clearColumns();
        for (var i=0; i<columnsQty; i++) {
            oneMoreColumnPlease()
        };
        return () => { window.removeEventListener('resize', updateWidth) }
    },[columnsQty]);

    useEffect(() => {
        const columnHeights = [...document.querySelectorAll('.wish-column')].map(col => col.clientHeight);
        const shortestColumn = columnHeights.indexOf(Math.min(...columnHeights))
        console.log(shortestColumn);
        (shortestColumn >= 0) &&  dispatch(takeWishToRender(shortestColumn));
    },[wishesToRender]);

    return (
        <AppLayout>
            {columnObjects.map(column =>
                <div key={column.id} className={'wish-column'}>
                    { column.wishes.map(wish =>
                        <WishCard wish={ wish } key={ wish.id }/>) }
                </div>)}
        </AppLayout>
    );
}

//{columnObjects.map(column => <div key={column.id} className={'wish-column'}><div className='wish-mock'></div></div>)}

//{columnObjects.map(column => <WishColumn column={column} key={column.id}/>)}

//{ wishes.map((wish, index) => <WishCard wish={ wish } key={ index }/>) }


