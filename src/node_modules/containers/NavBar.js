import React, { useLayoutEffect } from 'react'
import { NavLink, useMatch, useParams } from 'react-router-dom'
import { Outlet, useLocation } from 'react-router'
import { useDispatch } from 'react-redux'

import { ModeToggle } from 'components/ModeToggle'
import { Highlighter } from 'components/Highlighter'
import { highlightBreadCrumbStart, highlightBreadCrumbFinish } from 'store/highlighterSlice'
import { getWishById, getWishlistById } from 'getters'



export const NavBar = () => {
    const location = useLocation().pathname.split('/').slice(1,3).join('/')

    const { wishlistId, wishId } = useParams();
    const wishlist = getWishlistById(wishlistId);
    const wishlistName = wishlist && wishlist.title;
    const wish = getWishById(wishId);
    const wishName = wish && wish.title;

    const Option = ({ to, children, isBreadCrumb }) => {
        return (
            <NavLink
                to={ to }
                className='nav option'
                end={ isBreadCrumb }
            >
                { children }
            </NavLink>
        );
    }
    const Slash = () => <div className='nav'>/</div>

    let BreadCrumbs;
    switch (location) {
        case 'my-wishes/items':
            BreadCrumbs = () => (
                <div className='bread-crumbs'>
                    <Highlighter location='navbar'/>
                    <Option to='/my-wishes/items/actual'>Актуальные</Option>
                    <Option to='/my-wishes/items/completed'>Исполненные</Option>
                    <Option to='/my-wishes/items/all'>Все</Option>
                </div>
            );
            break;
        case 'my-wishes/lists':
            BreadCrumbs = () => (
                <div className='bread-crumbs'>
                    <Highlighter location='navbar'/>
                    <Option to='/my-wishes/lists/' isBreadCrumb={ true }>Вишлисты</Option>
                    
                    { wishlistId && <Slash/> }
                    { wishlistId &&
                    <Option to={`/my-wishes/lists/${wishlistId}`} isBreadCrumb={ true }>{ wishlistName }</Option>}
                    
                    { wishId && <Slash/> }
                    { wishId &&
                    <Option to={`/my-wishes/lists/${wishlistId}/${wishId}`} isBreadCrumb={ true }>{ wishName }</Option>}
                </div>
            );
            break;
        case 'my-invites/items':
            BreadCrumbs = () => (
                <div className='bread-crumbs'>
                    <Highlighter location='navbar'/>
                    <Option to='/my-invites/items/reserved'>Зарезервированные</Option>
                    <Option to='/my-invites/items/completed'>Подаренные</Option>
                    <Option to='/my-invites/items/all'>Все</Option>
                </div>
            );
            break;
        case 'my-invites/lists':
            BreadCrumbs = () => (
                <div className='bread-crumbs'>
                    <Highlighter location='navbar'/>
                    <Option to='/my-invites/lists/' isBreadCrumb={ true }>Вишлисты</Option>

                    { wishlistId && <Slash/> }                    
                    { wishlistId &&
                    <Option to={`/my-invites/lists/${wishlistId}`} isBreadCrumb={ true }>{ wishlistName }</Option>}
                    
                    { wishId && <Slash/> }
                    { wishId &&
                    <Option to={`/my-invites/lists/${wishlistId}/${wishId}`} isBreadCrumb={ true }>{ wishName }</Option>}
                </div>
            );
            break;
        default:
            break;
    }
    
    const dispatch = useDispatch();
    const setTransitions = () => { document.querySelector('.bread-crumbs .highlighter').classList.add('animated-short') }
    const clearTransitions = () => { document.querySelector('.bread-crumbs .highlighter').classList.remove('animated-short') }

    useLayoutEffect(() => {
        setTransitions();
        dispatch(highlightBreadCrumbStart());
        setTimeout(() => dispatch(highlightBreadCrumbFinish()), 300);
    });

    useLayoutEffect(() => {
        clearTransitions();
        dispatch(highlightBreadCrumbFinish());
    },[location]);

    const toggleShadow = () => {
        const isScrolled = document.querySelector('.work-space').scrollTop;
        const target = document.querySelector('.nav-bar');
        if(isScrolled) target.classList.add('with-shadow');
        if(!isScrolled) target.classList.remove('with-shadow');
    }

    return (
        <div className='app-body'>
            <div className='content-header'>
                <div className='nav-bar'>
                    <ModeToggle/>
                    <BreadCrumbs/>
                </div>
            </div>
            <div className='work-space' onScroll={ toggleShadow }>
                <Outlet/>
            </div>
        </div>
    )
}