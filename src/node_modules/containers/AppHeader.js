import React, { useEffect, useLayoutEffect } from 'react'
import { Link, useLocation } from 'react-router-dom'
import { Outlet } from 'react-router'
import { useDispatch, useSelector } from 'react-redux'

import { LogoIcon, LogoBack } from 'components/Icon'
import { Highlighter, Goo } from 'components/Highlighter'
import { switchSectionSlider } from 'store/sliderSlice'

export const AppHeader = () => {
    const currentSection = useLocation().pathname.split('/').at(1);
    const currentMode = useLocation().pathname.split('/').at(2);
    const myWishesLast = useSelector(state => state.history.myWishesSection.last);
    const myInvitesLast = useSelector(state => state.history.myInvitesSection.last);
    const isMyWishes = currentSection === 'my-wishes';
    const firstSectionTitle = currentMode === 'items'
                            ? 'Мои желания'
                            : 'Мои вишлисты'
    const secondSectionTitle = currentMode === 'items'
                             ? 'Желания друзей'
                             : 'Вишлисты друзей'

    const dispatch = useDispatch();
    const alignGooHighlighters = () => {
        const goo = document.querySelector('.goo-highlighters');
        const logo = document.querySelector('.logo-btn')?.getBoundingClientRect();
        if(!goo || !logo) return;
        goo.style.left = `${logo.x}px`;
        goo.style.width = `${logo.offsetWidth}px`;
    }
    const setTransitions = () => {
        document.querySelectorAll('.goo-highlighters .highlighter').forEach((elem) => {
            elem.classList.add('animated-long');
        });
    }
    const clearTransitions = () => {
        document.querySelectorAll('.goo-highlighters .highlighter').forEach ((elem) => {
        elem.classList.remove('animated-long');
    })}
    const handleLogoClick = () => {
        console.log('i wisssh u :::3')
    } 

    useLayoutEffect(() => {
        alignGooHighlighters();
        window.addEventListener('resize', () => { alignGooHighlighters() })
        return () => {
            window.removeEventListener('resize', alignGooHighlighters)
        }
    },[])

    useEffect(() => {
        setTransitions();
        dispatch(switchSectionSlider());
        setTimeout(clearTransitions, 600);
    },[currentSection, currentMode])
        
    return (
        <div className='app-layout'>
            <div className='app-header'>
                <div className='goo-highlighters'>
                    <Highlighter location='left-section-slider'/>
                    <Highlighter location='right-section-slider'/>
                    <LogoBack/>
                    <Goo/>
                </div>
                <div className='center-group'>
                    <Link
                        to={ myWishesLast }
                        className={ isMyWishes ? 'section my-wishes active' : 'section my-wishes' }
                    >
                        { firstSectionTitle }
                    </Link>
                    <button onClick={handleLogoClick} className='logo-btn'>
                        <LogoIcon/>
                    </button>
                    <Link
                        to={ myInvitesLast }
                        className={ isMyWishes ? 'section my-invites' : 'section my-invites active' }
                    >
                        { secondSectionTitle }
                    </Link>
                </div>
            </div>
            
            <Outlet/>
            
        </div>
    );
}