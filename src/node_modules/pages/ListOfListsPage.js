import { React } from 'react'
import { useNavigate, useLocation } from 'react-router-dom'
import { useSelector } from 'react-redux'

import { WishlistLine } from 'containers/WishlistLine'
import { getDaysToEvent, sortByDateAscend, sortByDateDescend } from 'getters'

export const ListOfListsPage = () => {
    let navigate = useNavigate();
    const loca = useLocation().pathname;
    const wishlists = useSelector(state => {
        if(loca.split('/').at(1) === 'my-wishes')
            return state.wishlists.ofCurrentUser;
        else return state.wishlists.ofOtherUsers;
    });
    const events = wishlists.filter(list => list.date && list.author);
    const pastEvents = events
        .filter(event => getDaysToEvent(event) < 0)
        .sort(sortByDateDescend);
    const actualEvents = events
        .filter(event => !pastEvents.includes(event))
        .sort(sortByDateAscend);
    
    const handleClick = ( wishlistId ) => {
        const slashCorrection = loca.at(-1) === '/' ? '' : '/'
        const path = loca + slashCorrection;
        const delayParams = [200, 300, 600];

        const thisNode = document.getElementById(wishlistId);
        const allNodes = document.querySelectorAll(`.list-of-lists-page > div`);
        const workSpace = document.querySelector('.work-space');
        const navbar = document.querySelector('.nav-bar')

        const currentCoords = thisNode.getBoundingClientRect();
        const navbarCoords = navbar.getBoundingClientRect();
        
        const firstStep = () => {
            thisNode.classList.add('selected');
            allNodes.forEach(node => (node!==thisNode) && node.classList.add('hidden'));
        }
        const secondStep = () => {
            thisNode.style.cssText = `
                position: fixed;
                width: ${currentCoords.width}px;
                top: ${currentCoords.y}px;
                transition: all ease-in-out 240ms;
            `;
        }
        const thirdStep = () => {
            thisNode.style.top = `${navbarCoords.y + navbarCoords.height}px`
            thisNode.style.padding = `1rem 2rem`;
            navbar.classList.remove('with-shadow');
        }
        const lastStep = () => {
            navigate(path + wishlistId)
            workSpace.scrollTo(0, 0);
        }

        firstStep();
        setTimeout(secondStep, delayParams[0]);
        setTimeout(thirdStep, delayParams[1]);
        setTimeout(lastStep, delayParams[2]);
    };

    return (
        <div className='list-of-lists-page'>
            { actualEvents.length ? actualEvents.map((item, index) => (
                <WishlistLine
                    wishlist={ item }
                    onClick={() => handleClick(item.id)}
                    key={ index }
                />
            )) : null}
            { pastEvents.length ? (
                <div className='group-header'>
                    <span>Прошедшие события</span>
                </div>
            ) : null}
            { pastEvents.map((item, index) => (
                <WishlistLine
                    wishlist={ item }
                    onClick={() => handleClick(item.id)}
                    key={ index }
                />
            ))}
        </div>
    );
}